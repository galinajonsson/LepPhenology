---
title: "02-ClimateData"
author: "Galina M. JÃ¶nsson"
date: "30/03/2020"
output: html_document
---

```{r temp-data, echo=FALSE}
library(ncdf4)

nc_data <- nc_open('../data/tas_hadukgrid_uk_5km_mon_190001-190012.nc')

print(nc_data)


yCoord <- ncvar_get(nc_data,"projection_y_coordinate")
nyCoord <- dim(yCoord)
head(yCoord)


xCoord <- ncvar_get(nc_data,"projection_x_coordinate")
nxCoord <- dim(xCoord)
head(xCoord)

print(c(nyCoord,nxCoord))


# get time
time <- ncvar_get(nc_data,"time")
time

tunits <- ncatt_get(nc_data,"time","units")
nt <- dim(time)
nt

tunits

dname <- "tas"  # note: tmp means temperature (not temporary)
tmp_array <- ncvar_get(nc_data,dname)
dlname <- ncatt_get(nc_data,dname,"long_name")
dunits <- ncatt_get(nc_data,dname,"units")
fillvalue <- ncatt_get(nc_data,dname,"_FillValue")
dim(tmp_array)


# get global attributes
title <- ncatt_get(nc_data,0,"title")
institution <- ncatt_get(nc_data,0,"institution")
datasource <- ncatt_get(nc_data,0,"source")
references <- ncatt_get(nc_data,0,"references")
history <- ncatt_get(nc_data,0,"history")
Conventions <- ncatt_get(nc_data,0,"Conventions")


# convert time -- split the time units string into fields
library(chron)
tustr <- strsplit(tunits$value, " ")
tdstr <- strsplit(unlist(tustr)[3], "-")
tmonth <- as.integer(unlist(tdstr)[2])
tday <- as.integer(unlist(tdstr)[3])
tyear <- as.integer(unlist(tdstr)[1])
chron(time,origin=c(tmonth, tday, tyear))


# replace netCDF fill values with NA's
tmp_array[tmp_array==fillvalue$value] <- NA

length(na.omit(as.vector(tmp_array[,,1])))

# get a single slice or layer (January)
m <- 1
tmp_slice <- tmp_array[,,m]

tmp_slice


# create dataframe -- reshape data
# matrix (nlon*nlat rows by 2 cols) of lons and lats
lonlat <- as.matrix(expand.grid(yCoord,xCoord))
dim(lonlat)

tmp_vec <- as.vector(tmp_slice)
length(tmp_vec)


# create dataframe and add names
tmp_df01 <- data.frame(cbind(lonlat,tmp_vec))
names(tmp_df01) <- c("yCoord","xCoord",paste(dname,as.character(m), sep="_"))
head(na.omit(tmp_df01), 10)


unique(tmp_df01$tas_1)
```





