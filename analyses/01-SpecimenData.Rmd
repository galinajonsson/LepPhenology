---
title: "01-SpecimenData"
author: "Galina M. Jönsson"
date: "25/03/2020"
output: html_document
---

Read all NHM specimen data with error radius <10 km and day-level record precision
```{r setup, include=FALSE}
NHMdat <- read.csv("../data/cleanNHMdat/nhm_all_clean_specimens.csv")

# Find the julan day for collection dates
NHMdat$date <- as.Date(NHMdat$date, "%Y-%m-%d")
NHMdat$jDate <- format(NHMdat$date, "%j")
NHMdat$jDate <- as.numeric(NHMdat$jDate)

# Remove any 


### loop through species and find mean and standard deviation for jDate across years
# Create species names vecor
spp <- as.vector(levels(NHMdat$species))

# Create dataframe to populate
jDateSummary <- data.frame(species = as.factor(spp),
                              mean_jDate = as.numeric(NA),
                              SD_jDate = as.numeric(NA))

for(i in 1:length(spp)){
  X <- split(NHMdat, NHMdat$species)
  temp <- X[[i]]
  
  jDateSummary[i,2] <- mean(temp$jDate)
  jDateSummary[i,3] <- sd(temp$jDate)
}
jDateSummary$Min_jDate <- jDateSummary$mean_jDate - 3*jDateSummary$SD_jDate
jDateSummary$Max_jDate <- jDateSummary$mean_jDate + 3*jDateSummary$SD_jDate


### Loop though each species and remove all specimens more than 3 standard deviation form mean jDate

# Split the dat frame into one dtaframe per species 
NHMdatSplit <- split(NHMdat, NHMdat$species)

for(i in 1:length(NHMdatSplit)){
  NHMdatSplit[[i]] <- NHMdatSplit[[i]][(NHMdatSplit[[i]]$jDate < jDateSummary[i,"Max_jDate"]),]
  NHMdatSplit[[i]] <- NHMdatSplit[[i]][(NHMdatSplit[[i]]$jDate > jDateSummary[i,"Min_jDate"]),]
}


### Loop though each species, find the numebr of records per year and merge this data with as a separate column

# Split the dat frame into one dtaframe per species 
NHMdatSplit <- split(NHMdat, NHMdat$species)

for(i in 1:length(NHMdatSplit)){
  require(dplyr)
  SpecimepnPerSpp <- NHMdatSplit[[i]] %>% group_by(year) %>% tally()
  NHMdatSplit[[i]] <- merge(NHMdatSplit[[i]], SpecimepnPerSpp, by="year", all.x = TRUE)
  NHMdatSplit[[i]] <- NHMdatSplit[[i]][(NHMdatSplit[[i]]$n > 4),]
}

# Combine into one data frame
NHMclean <- bind_rows(NHMdatSplit, .id = "column_label")

# Find records per species
require(dplyr)
SpecimepnPerSpp <- NHMclean %>% group_by(species) %>% tally()
SpecimepnPerSpp
```

### Univoltine species
First, I will subset the univoltine species (designation according to Dennis et al., 2017; http://dx.doi.org/10.1016/j.ecolind.2017.01.009)

The univoltine species are:
- Erynnis tages  
- Thymelicus lineola  
- Pyronia tithonus  
- Callophrys rubi  
- Pyrgus malvae  
- Ochlodes sylvanus  
- Melanargia galathea  
- Maniola jurtina  
- Anthocharis cardamines  
- Favonius quercus  
- Aphantopus hyperantus  
- Thymelicus sylvestris  



```{r temporal-spread-raw}
uniVolSpp <- c("Erynnis tages", "Thymelicus lineola", "Pyronia tithonus", "Callophrys rubi", "Pyrgus malvae", "Ochlodes sylvanus", "Melanargia galathea", "Maniola jurtina", "Anthocharis cardamines", "Favonius quercus", "Aphantopus hyperantus", "Thymelicus sylvestris")
length(uniVolSpp)

NHMcleanUniVol <- subset(NHMclean, species %in% uniVolSpp)
NHMcleanUniVol <- droplevels(NHMcleanUniVol)

for(i in 1:length(uniVolSpp)){
  hist((subset(NHMcleanUniVol, species == uniVolSpp[i]))$jDate, xlab = "Julian day", ylab = "Specimen records", main = uniVolSpp[i])
}

# Find records per species
require(dplyr)
SpecimepnPerSpp <- NHMcleanUniVol %>% group_by(species) %>% tally()
SpecimepnPerSpp

#######################################################################
############################ Erynnis tages ############################
#######################################################################

Erynnis_tages <- subset(NHMcleanUniVol, species == "Erynnis tages") # 511 obs
Erynnis_tages$year <- as.factor(as.character(Erynnis_tages$year))

## Map records
require(BRCmap)
#Load UK data
data(UK)

# Plot UK outline
plot_GIS(UK, new.window = FALSE)
  
# Add these grid references to an exisiting plot
plotUK_gr(Erynnis_tages$km10grid, col="red")

Erynnis_tagesYearly <- data.frame(year = as.factor(unique(Erynnis_tages$year)),
                                  qunatile10 = as.numeric(NA),
                                  qunatile90 = as.numeric(NA),
                                  median = as.numeric(NA),
                                  earlies = as.numeric(NA),
                                  CollectionPeriod = as.numeric(NA))

for(i in 1:length(unique(Erynnis_tages$year))){
  temp <- subset(Erynnis_tages, year == (unique(Erynnis_tages$year)[i]))
  Erynnis_tagesYearly[i,2] <- quantile((temp$jDate), 0.10)
  Erynnis_tagesYearly[i,3] <- quantile((temp$jDate), 0.90)  
  Erynnis_tagesYearly[i,4] <- median(temp$jDate) 
  Erynnis_tagesYearly[i,5] <- min(temp$jDate) 
  Erynnis_tagesYearly[i,6] <- Erynnis_tagesYearly[i,3] - Erynnis_tagesYearly[i,2]
}


# Merge Erynnis_tagesYearly with the Erynnis_tages by year
Erynnis_tages <- merge(Erynnis_tages, Erynnis_tagesYearly, by="year", all.x=TRUE)
                                  


#######################################################################
########################### Maniola jurtina ###########################
#######################################################################

Maniola_jurtina <- subset(NHMcleanUniVol, species == "Maniola jurtina")
Maniola_jurtina$year <- as.factor(as.character(Maniola_jurtina$year))

# Plot UK outline
plot_GIS(UK, new.window = FALSE)
# Add these grid references to an exisiting plot
plotUK_gr(Maniola_jurtina$km10grid, col="red")

Maniola_jurtinaYearly <- data.frame(year = as.factor(unique(Maniola_jurtina$year)),
                                  qunatile10 = as.numeric(NA),
                                  qunatile90 = as.numeric(NA),
                                  median = as.numeric(NA),
                                  earlies = as.numeric(NA),
                                  CollectionPeriod = as.numeric(NA))

for(i in 1:length(unique(Maniola_jurtina$year))){
  temp <- subset(Maniola_jurtina, year == (unique(Maniola_jurtina$year)[i]))
  Maniola_jurtinaYearly[i,2] <- quantile((temp$jDate), 0.10)
  Maniola_jurtinaYearly[i,3] <- quantile((temp$jDate), 0.90)  
  Maniola_jurtinaYearly[i,4] <- median(temp$jDate) 
  Maniola_jurtinaYearly[i,5] <- min(temp$jDate) 
  Maniola_jurtinaYearly[i,6] <- Erynnis_tagesYearly[i,3] - Erynnis_tagesYearly[i,2]
}

# Merge Maniola_jurtinaYearly with the Maniola_jurtina by year
Maniola_jurtina <- merge(Maniola_jurtina, Maniola_jurtinaYearly, by="year", all.x=TRUE)








```



The relationship between spring temperatures (March–May) and earliest, median, 10th percentile, and 90th percentile collection date, length of collection period (range of 10th to 90th percentiles) and all data in a particular year,
```{r temporal-spread-raw}
require(ggplot2)
p <- ggplot((NHMcleanUniVol %>%
    group_by(species, year) %>%
    tally()), aes(year, n)) + geom_point() +
    facet_grid(rows = vars(species))
p

```



